<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>おかね記録</title>
    <!-- Tailwind CSSの読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesomeの読み込み -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* UIの操作性を向上させるためのカスタムスタイル */
        body {
            -webkit-user-select: none; /* テキスト選択を無効化 */
            user-select: none;
            -webkit-tap-highlight-color: transparent; /* タップ時のハイライトを無効化 */
            touch-action: manipulation; /* ダブルタップによるズームを無効化 */
        }
        /* ボタンのアクティブ状態のスタイル */
        .btn-active {
            transform: scale(0.95);
            opacity: 0.8;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-lg">
        <header class="bg-teal-500 text-white text-center p-4 shadow-md">
            <h1 class="text-2xl font-bold">おかね記録</h1>
        </header>

        <main class="p-4 md:p-6 space-y-6">
            <!-- 日付表示とナビゲーション -->
            <div class="flex items-center justify-between">
                <button id="prev-day" class="p-2 text-teal-500 rounded-full hover:bg-teal-100 transition-all">
                    <i class="fas fa-chevron-left fa-lg"></i>
                </button>
                <h2 id="current-date" class="text-xl font-semibold text-gray-700"></h2>
                <button id="next-day" class="p-2 text-teal-500 rounded-full hover:bg-teal-100 transition-all">
                    <i class="fas fa-chevron-right fa-lg"></i>
                </button>
            </div>

            <!-- 金額入力エリア -->
            <div class="bg-slate-100 p-4 rounded-lg shadow-inner">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button class="amount-btn p-3 bg-white rounded-lg shadow-sm text-lg font-bold text-gray-700" data-amount="1000">1000円</button>
                    <button class="amount-btn p-3 bg-white rounded-lg shadow-sm text-lg font-bold text-gray-700" data-amount="500">500円</button>
                    <button class="amount-btn p-3 bg-white rounded-lg shadow-sm text-lg font-bold text-gray-700" data-amount="150">150円</button>
                    <button class="amount-btn p-3 bg-white rounded-lg shadow-sm text-lg font-bold text-gray-700" data-amount="100">100円</button>
                </div>
                
                <div class="flex items-center justify-center space-x-4">
                    <button id="decrease-qty" class="w-12 h-12 bg-blue-400 text-white rounded-full text-2xl font-bold flex items-center justify-center shadow-md transition-transform active:scale-95">-</button>
                    <div id="selected-value" class="text-3xl font-bold text-center text-teal-600 w-40">1000円</div>
                    <button id="increase-qty" class="w-12 h-12 bg-blue-400 text-white rounded-full text-2xl font-bold flex items-center justify-center shadow-md transition-transform active:scale-95">+</button>
                </div>
                
                <div class="mt-4 flex items-center space-x-2">
                    <button id="toggle-type-btn" class="w-28 p-3 text-white font-bold rounded-lg shadow-md transition-colors text-lg">
                        + 収入
                    </button>
                    <button id="save-btn" class="flex-grow p-3 bg-teal-500 text-white font-bold rounded-lg shadow-md hover:bg-teal-600 transition-all text-lg">
                        <i class="fas fa-save mr-2"></i>保存する
                    </button>
                </div>
            </div>

            <!-- 集計表示エリア -->
            <div class="grid grid-cols-2 gap-4 text-center">
                <div class="bg-indigo-100 p-3 rounded-lg">
                    <h3 class="text-sm font-semibold text-indigo-800">今月の合計</h3>
                    <p id="monthly-total" class="text-2xl font-bold text-indigo-900">0円</p>
                </div>
                <div class="bg-green-100 p-3 rounded-lg">
                    <h3 class="text-sm font-semibold text-green-800">今までの合計</h3>
                    <p id="grand-total" class="text-2xl font-bold text-green-900">0円</p>
                </div>
            </div>

            <!-- 記録リスト -->
            <div>
                <h3 class="text-lg font-semibold mb-2 text-gray-600 border-b-2 border-teal-200 pb-1">今日の記録</h3>
                <ul id="daily-log" class="space-y-2">
                    <!-- 記録はここに動的に追加されます -->
                </ul>
                <p id="no-log-message" class="text-gray-500 text-center mt-4 hidden">今日の記録はありません。</p>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ----- DOM要素の取得 -----
            const currentDateEl = document.getElementById('current-date');
            const prevDayBtn = document.getElementById('prev-day');
            const nextDayBtn = document.getElementById('next-day');
            const amountBtns = document.querySelectorAll('.amount-btn');
            const decreaseQtyBtn = document.getElementById('decrease-qty');
            const increaseQtyBtn = document.getElementById('increase-qty');
            const selectedValueEl = document.getElementById('selected-value');
            const saveBtn = document.getElementById('save-btn');
            const toggleTypeBtn = document.getElementById('toggle-type-btn');
            const monthlyTotalEl = document.getElementById('monthly-total');
            const grandTotalEl = document.getElementById('grand-total');
            const dailyLogEl = document.getElementById('daily-log');
            const noLogMessage = document.getElementById('no-log-message');
            
            // ----- 状態管理 -----
            let currentDate = new Date();
            let savingsData = {}; // { 'YYYY-MM-DD': [{ amount: 1000, qty: 1, id: '...', type: 'positive' }] }
            let selectedAmount = 1000;
            let quantity = 1;
            let isPositive = true; // true: 収入, false: 支出
            
            // ----- 初期化処理 -----
            const init = () => {
                loadData();
                addEventListeners();
                updateDisplay();
                updateSelectedAmountUI(document.querySelector('.amount-btn[data-amount="1000"]'));
                updateTypeUI();
            };

            // ----- データ処理 -----
            const loadData = () => {
                const data = localStorage.getItem('savingsAppData');
                savingsData = data ? JSON.parse(data) : {};
            };

            const saveData = () => {
                localStorage.setItem('savingsAppData', JSON.stringify(savingsData));
            };

            // ----- イベントリスナー -----
            const addEventListeners = () => {
                prevDayBtn.addEventListener('click', () => changeDay(-1));
                nextDayBtn.addEventListener('click', () => changeDay(1));
                
                amountBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        selectedAmount = parseInt(btn.dataset.amount);
                        quantity = 1;
                        updateSelectedValue();
                        updateSelectedAmountUI(btn);
                    });
                });

                decreaseQtyBtn.addEventListener('click', () => {
                    if (quantity > 1) {
                        quantity--;
                        updateSelectedValue();
                    }
                });

                increaseQtyBtn.addEventListener('click', () => {
                    quantity++;
                    updateSelectedValue();
                });
                
                toggleTypeBtn.addEventListener('click', () => {
                    isPositive = !isPositive;
                    updateTypeUI();
                });

                saveBtn.addEventListener('click', saveSaving);

                // イベント委任
                dailyLogEl.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-btn');
                    if (deleteBtn) {
                        const dateKey = deleteBtn.dataset.date;
                        const entryId = deleteBtn.dataset.id;
                        deleteSaving(dateKey, entryId);
                    }
                });
            };

            const changeDay = (direction) => {
                currentDate.setDate(currentDate.getDate() + direction);
                updateDisplay();
            };

            const saveSaving = () => {
                const dateKey = formatDate(currentDate);
                if (!savingsData[dateKey]) {
                    savingsData[dateKey] = [];
                }
                const newEntry = {
                    amount: selectedAmount,
                    qty: quantity,
                    id: Date.now().toString(),
                    type: isPositive ? 'positive' : 'negative'
                };
                savingsData[dateKey].push(newEntry);
                saveData();
                updateDisplay();

                // 保存ボタンのフィードバック
                saveBtn.classList.add('bg-green-500');
                saveBtn.innerHTML = '<i class="fas fa-check mr-2"></i>保存しました！';
                setTimeout(() => {
                    saveBtn.classList.remove('bg-green-500');
                    saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>保存する';
                }, 1500);
            };

            const deleteSaving = (dateKey, entryId) => {
                if(savingsData[dateKey]) {
                    savingsData[dateKey] = savingsData[dateKey].filter(entry => entry.id !== entryId);
                    if(savingsData[dateKey].length === 0){
                        delete savingsData[dateKey];
                    }
                    saveData();
                    updateDisplay();
                }
            };
            
            // ----- UI更新 -----
            const updateDisplay = () => {
                const today = new Date();
                const isToday = formatDate(currentDate) === formatDate(today);
                currentDateEl.textContent = isToday ? '今日' : formatDateForDisplay(currentDate);
                
                updateDailyLog();
                updateTotals();
            };

            const updateSelectedAmountUI = (activeBtn) => {
                amountBtns.forEach(btn => {
                    btn.classList.remove('bg-teal-200', 'ring-2', 'ring-teal-500');
                    btn.classList.add('bg-white');
                });
                activeBtn.classList.add('bg-teal-200', 'ring-2', 'ring-teal-500');
                activeBtn.classList.remove('bg-white');
            };
            
            const updateTypeUI = () => {
                if (isPositive) {
                    toggleTypeBtn.classList.remove('bg-red-500');
                    toggleTypeBtn.classList.add('bg-green-500');
                    toggleTypeBtn.innerHTML = '+ 収入';
                } else {
                    toggleTypeBtn.classList.remove('bg-green-500');
                    toggleTypeBtn.classList.add('bg-red-500');
                    toggleTypeBtn.innerHTML = '- 支出';
                }
                updateSelectedValue();
            };

            const updateSelectedValue = () => {
                selectedValueEl.textContent = `${selectedAmount * quantity}円`;
                 if (isPositive) {
                    selectedValueEl.classList.remove('text-red-500');
                    selectedValueEl.classList.add('text-teal-600');
                } else {
                    selectedValueEl.classList.remove('text-teal-600');
                    selectedValueEl.classList.add('text-red-500');
                }
            };

            const updateDailyLog = () => {
                const dateKey = formatDate(currentDate);
                const entries = savingsData[dateKey] || [];
                
                dailyLogEl.innerHTML = '';
                
                if (entries.length > 0) {
                    noLogMessage.classList.add('hidden');
                    entries.forEach(entry => {
                        const isNegative = entry.type === 'negative';
                        const totalValue = entry.amount * entry.qty;
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between bg-white p-3 rounded-lg shadow-sm';
                        li.innerHTML = `
                            <span class="${isNegative ? 'text-red-600' : 'text-green-600'} font-medium">
                                ${isNegative ? '−' : '＋'} ${totalValue.toLocaleString()}円
                                <span class="text-gray-500 text-sm font-normal">(${entry.amount.toLocaleString()}円 x ${entry.qty})</span>
                            </span>
                            <button class="delete-btn text-red-400 hover:text-red-600" data-date="${dateKey}" data-id="${entry.id}">
                                <i class="fas fa-trash-alt fa-lg"></i>
                            </button>
                        `;
                        dailyLogEl.appendChild(li);
                    });
                } else {
                    noLogMessage.classList.remove('hidden');
                }
            };
            
            const updateTotals = () => {
                let grandTotal = 0;
                let monthlyTotal = 0;
                const currentMonth = formatDate(new Date()).substring(0, 7);

                for (const dateKey in savingsData) {
                    const totalForDay = savingsData[dateKey].reduce((sum, entry) => {
                        const value = entry.amount * entry.qty;
                        if (entry.type === 'negative') {
                            return sum - value;
                        }
                        return sum + value; // 過去のデータ（typeなし）は収入として計算
                    }, 0);
                    
                    grandTotal += totalForDay;
                    if (dateKey.substring(0, 7) === currentMonth) {
                        monthlyTotal += totalForDay;
                    }
                }
                
                grandTotalEl.textContent = `${grandTotal.toLocaleString()}円`;
                monthlyTotalEl.textContent = `${monthlyTotal.toLocaleString()}円`;
            };

            // ----- ヘルパー関数 -----
            const formatDateForDisplay = (date) => {
                const week = ['日', '月', '火', '水', '木', '金', '土'];
                const dayOfWeek = week[date.getDay()];
                return `${date.getMonth() + 1}月${date.getDate()}日 (${dayOfWeek})`;
            };
            
            const formatDate = (date) => {
                const y = date.getFullYear();
                const m = ('0' + (date.getMonth() + 1)).slice(-2);
                const d = ('0' + date.getDate()).slice(-2);
                return `${y}-${m}-${d}`;
            };
            
            // ----- アプリケーションの実行 -----
            init();
        });
    </script>
</body>
</html>

